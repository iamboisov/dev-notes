---
description: Область видимости переменных и замыкание
---

# Область видимости и замыкание

## Блоки кода

Если переменная объявлена внутри блока кода `{...}`, то она видна только внутри этого блока.

{% code overflow="wrap" %}
```javascript
{
  let message = "Hello"; // переменная видна только в этом блоке
  alert(message); // Hello
}

alert(message); // ReferenceError: message is not defined
```
{% endcode %}

Для `if`, `for`, `while` и т.д. переменные, объявленные в блоке кода `{...}`, также видны только внутри:

{% code overflow="wrap" %}
```javascript
if (true) {
  let phrase = "Hello";

  alert(phrase); // Hello
}

alert(phrase); // Ошибка
```
{% endcode %}

{% hint style="info" %}
Переменная, объявленная внутри `(...)`, считается частью блока.
{% endhint %}

## Вложенные функции

{% code overflow="wrap" %}
```javascript
function makeCounter() {
  let count = 0;
  return () => count++;
}

let counter = makeCounter()

console.log(counter()) // 0
console.log(counter()) // 1
```
{% endcode %}

Как вообще счетчик увеличивается? Сейчас разберемся..

## Лексическое окружение

### Переменные

В JavaScript у каждой выполняемой функции, блока кода `{...}` и скрипта есть связанный с ними внутренний (скрытый) объект, называемый лексическим окружением `LexicalEnvironment`.

Объект лексического окружения состоит из:

1. Environment record — объект, в котором как свойства хранятся все локальные переменные
2. Ссылка на внешнее лексическое окружение — то есть то, которое соответствует коду снаружи

Переменная — это свойство специального внутреннего объекта: Environment Record.

"Получить или изменить переменную" — означает "получить или изменить свойство этого объекта".

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```javascript
// Упрощенный пример того, как работает лексическое окружение
let LexicalEnvironment = {
  EnvironmentRecord: {
    variable: "John"
  }
};

let variable = "John";
// То же самое, что и LexicalEnvironment.EnvironmentRecord.variable
// То есть просто считываем свойтсво из объекта

// ---------------------------------------------------------
console.log(variable)
console.log(LexicalEnvironment.EnvironmentRecord.variable)
```
{% endcode %}

* Переменная – это свойство специального внутреннего объекта, связанного с текущим выполняющимся блоком/функцией/скриптом.
* Работа с переменными – это на самом деле работа со свойствами этого объекта.

{% hint style="info" %}
«Лексическое окружение» – это объект спецификации: он существует только «теоретически» в спецификации языка для описания того, как все работает. Мы не можем получить этот объект в нашем коде и манипулировать им напрямую.
{% endhint %}

### Function Declaration

Функция — это тоже значение, что и переменная.

Разница заключается в том, что Function Declaration мгновенно инициализируется полностью.

Когда создается лексическое окружение, Function Declaration сразу же становится функцией, готовой к использованию (в отличие от `let`, который до момента объявления не может быть использован).

Именно поэтому мы можем вызвать функцию, объявленную как Function Declaration, до самого её объявления.

### Внутреннее и внешнее лексическое окружение

Когда запускается выполнение функции, в начале ее вызова автоматически создается новое лексическое окружение для хранения локальных переменных и параметров вызова.

Пример для say("John"):

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

